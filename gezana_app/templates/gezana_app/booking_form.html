{% extends "gezana_app/base.html" %}
{% block title %}Book a Table{% endblock %}

{% block content %}
<section class="booking-hero">
  <div>
    <p class="eyebrow">Reserve Your Table</p>
    <h2>Book a cozy spot for friends, family, or coffee ceremony</h2>
    <p class="lede">
      Choose your date and time, and we will find the best table.
      We welcome small gatherings and celebrations.
    </p>
  </div>
  <div class="booking-hero-badge">
    <p class="mini">Hours</p>
    <p class="callout">12:00 PM — 7:00 PM</p>
    <p class="note">Walk-ins welcome, but booking is recommended.</p>
  </div>
</section>

{# ✅ Non-field errors (form-level errors) #}
{% if form.non_field_errors %}
  <div class="form-errors card" role="alert">
    {% for error in form.non_field_errors %}
      <p>{{ error }}</p>
    {% endfor %}
  </div>
{% endif %}

<div class="booking-layout">
  <div class="booking-card card">
    <h3>Booking Details</h3>

    <form method="post" novalidate>
      {% csrf_token %}

      {# ✅ Global warning container (JS will fill this) #}
      <div id="live-warnings" class="form-errors card" style="display:none;" role="alert"></div>

      <div class="field-block">
        <div class="input-group">
          <i class="fa-solid fa-user"></i>
          {{ form.name }}
        </div>
        {% if form.name.errors %}
          <div class="field-errors">
            {% for e in form.name.errors %}<p>{{ e }}</p>{% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="field-block">
        <div class="input-group">
          <i class="fa-solid fa-envelope"></i>
          {{ form.email }}
        </div>
        {% if form.email.errors %}
          <div class="field-errors">
            {% for e in form.email.errors %}<p>{{ e }}</p>{% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="field-block">
        <div class="input-group">
          <i class="fa-solid fa-phone"></i>
          {{ form.phone }}
        </div>
        {% if form.phone.errors %}
          <div class="field-errors">
            {% for e in form.phone.errors %}<p>{{ e }}</p>{% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="field-block">
        <div class="input-group">
          <i class="fa-solid fa-users"></i>
          {{ form.guests }}
        </div>
        {% if form.guests.errors %}
          <div class="field-errors">
            {% for e in form.guests.errors %}<p>{{ e }}</p>{% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="field-block">
        <div class="input-group">
          <i class="fa-solid fa-calendar-days"></i>
          {{ form.date }}
        </div>
        {% if form.date.errors %}
          <div class="field-errors">
            {% for e in form.date.errors %}<p>{{ e }}</p>{% endfor %}
          </div>
        {% endif %}
        <p class="hint">Bookings cannot be made for past dates.</p>
      </div>

      <div class="field-block">
        <div class="input-group">
          <i class="fa-solid fa-clock"></i>
          {{ form.time }}
        </div>
        {% if form.time.errors %}
          <div class="field-errors">
            {% for e in form.time.errors %}<p>{{ e }}</p>{% endfor %}
          </div>
        {% endif %}
        <p class="hint">Booking hours: 12:00–19:00</p>
      </div>

      <button type="submit" class="button primary full">Confirm Booking</button>
    </form>
  </div>

  <div class="booking-side card">
    <h3>Good to Know</h3>
    <ul class="bullet-list">
      <li>Bookings available 12:00 PM – 7:00 PM.</li>
      <li>We’ll seat you at the best available table for your party size.</li>
      <li>Please call if you’re running late; we hold tables for 15 minutes.</li>
    </ul>

    <div class="divider"></div>

    <h3>Need to cancel?</h3>
    <p>Enter your reference code below or visit the cancel page.</p>
    <form action="{% url 'gezana_app:cancel_booking' %}" method="post" class="inline-cancel-form">
      {% csrf_token %}
      <input type="text" name="reference" placeholder="Enter reference code" required />
      <button type="submit" class="button danger">Cancel booking</button>
      <a class="button ghost" href="{% url 'gezana_app:cancel_booking' %}">Go to cancel page</a>
    </form>
  </div>
</div>

{# ✅ Optional client-side warning for instant feedback (server-side validation still applies) #}
<script>
(function () {
  const warningsBox = document.getElementById("live-warnings");
  const dateInput = document.querySelector('input[name="date"]');
  const timeSelect = document.querySelector('select[name="time"]');

  function showWarnings(messages) {
    if (!messages.length) {
      warningsBox.style.display = "none";
      warningsBox.innerHTML = "";
      return;
    }
    warningsBox.style.display = "block";
    warningsBox.innerHTML = messages.map(m => `<p>${m}</p>`).join("");
  }

  function validateLive() {
    const messages = [];

    // Date warning
    if (dateInput && dateInput.value) {
      const today = new Date();
      today.setHours(0,0,0,0);
      const chosen = new Date(dateInput.value + "T00:00:00");
      if (chosen < today) {
        messages.push("❌ You cannot book a date in the past.");
      }
    }

    // Time warning (12:00 - 19:00)
    if (timeSelect && timeSelect.value) {
      const [hh, mm] = timeSelect.value.split(":").map(Number);
      const minutes = hh * 60 + mm;
      const open = 12 * 60;
      const close = 19 * 60;
      if (minutes < open || minutes > close) {
        messages.push("❌ Bookings must be between 12:00 and 19:00.");
      }
    }

    showWarnings(messages);
  }

  if (dateInput) dateInput.addEventListener("change", validateLive);
  if (timeSelect) timeSelect.addEventListener("change", validateLive);
})();
</script>

{% endblock %}
